name: Generate Mihomo MRS Rules

on:
  workflow_dispatch:
  push:
    branches: [main]
  schedule:
    - cron: '0 2 * * *'

jobs:
  build_mrs:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Clone v2fly Data
        run: |
          git clone --depth 1 https://github.com/v2fly/domain-list-community.git

      - name: Prepare YAML Rules
        run: python v2fly2mihomo.py

      - name: Install Mihomo
        run: |
          # ä¸‹è½½æœ€æ–°çš„ Mihomo å†…æ ¸ç”¨äºç¼–è¯‘ MRS
          curl -L -o mihomo.gz https://github.com/MetaCubeX/mihomo/releases/download/v1.19.0/mihomo-linux-amd64-v1.19.0.gz
          gunzip mihomo.gz
          chmod +x mihomo

      - name: Compile MRS
        run: |
          mkdir -p mrs_rules
          # éå†ç”Ÿæˆçš„ yaml æ–‡ä»¶å¹¶ç¼–è¯‘ä¸º mrs
          for file in mihomo_rules/*.yaml; do
            filename=$(basename "$file" .yaml)
            ./mihomo rule-set compile "$file" -o "mrs_rules/${filename}.mrs"
          done

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ¤– Update MRS Rules"
          file_pattern: 'mrs_rules/*.mrs'
